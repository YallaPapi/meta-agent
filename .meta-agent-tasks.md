# Meta-Agent Implementation Tasks

## Instructions for Claude Code

This file contains implementation tasks identified by meta-agent analysis.
Please work through these tasks in order, checking each box when complete.

### How to use this file:
1. Read through all tasks to understand the scope
2. Start with critical/high priority tasks first
3. Check the file path for context on where to make changes
4. Mark tasks complete by changing `[ ]` to `[x]`
5. Commit changes after completing related tasks

---

## Task Summary

- **Critical:** 4 task(s)
- **High:** 5 task(s)
- **Medium:** 4 task(s)
- **Low:** 1 task(s)
- **Total:** 14 task(s)

---

## Tasks

### 1. 游댮 Implement Repomix output caching

- [ ] **Status:** Not started
- **Priority:** Critical
- **File:** `src/metaagent/repomix.py`

**Description:**

Cache repomix output with SHA256 hash of repo contents in repomix.py. Skip repomix execution if cache is valid (within 5 minutes). Add cache invalidation on git changes. Store cache in .metaagent/cache/ directory.

### 2. 游댮 Establish secure secrets and configuration handling

- [ ] **Status:** Not started
- **Priority:** Critical
- **File:** `src/metaagent/config.py`

**Description:**

Design and implement a configuration layer that reads PERPLEXITY_API_KEY, ANTHROPIC_API_KEY, and other sensitive settings strictly from environment variables, never logs their values, and avoids writing them to plan or history files. Add input validation for configuration (timeouts, max tokens) and ensure config defaults are safe (e.g., conservative token limits, non-verbose logging by default).

### 3. 游댮 Harden Repomix subprocess execution

- [ ] **Status:** Not started
- **Priority:** Critical
- **File:** `src/metaagent/repomix.py`

**Description:**

Implement secure subprocess invocation for Repomix: avoid shell=True, sanitize and validate the --repo path, enforce timeouts, and robustly handle errors. Log only necessary metadata (exit codes, high-level messages) and ensure that no sensitive content (e.g., packed secrets) is accidentally logged. Consider a denylist/allowlist for directories and file types included in packs to avoid leaking secrets.

### 4. 游댮 Validate and sanitize LLM prompts and responses

- [ ] **Status:** Not started
- **Priority:** Critical
- **File:** `src/metaagent/analysis.py`

**Description:**

Define a strict schema for analysis engine responses (summary, recommendations, tasks) and implement robust JSON parsing with validation and error handling. Reject or sanitize responses that include suspicious content (e.g., shell commands, code that modifies environment, sensitive file paths) before writing them into mvp_improvement_plan.md. Add guardrails to prevent prompt injection from PRD or codebase content from causing unsafe instructions to be passed downstream to Claude Code.

### 5. 游 Add performance profiling to orchestrator

- [ ] **Status:** Not started
- **Priority:** High
- **File:** `src/metaagent/orchestrator.py`

**Description:**

Integrate cProfile or py-spy to measure execution time of each stage in orchestrator.py. Log top 5 slowest functions and total runtime per refinement cycle. Add profiling results to mvp_improvement_plan.md.

### 6. 游 Add async LLM calls with timeout

- [ ] **Status:** Not started
- **Priority:** High
- **File:** `src/metaagent/analysis.py`

**Description:**

Replace synchronous Perplexity API calls in analysis.py with asyncio-based httpx client. Add configurable timeout (default 120s) and max_concurrent=3. Include circuit breaker pattern for repeated failures.

### 7. 游 Implement stage-level parallelism

- [ ] **Status:** Not started
- **Priority:** High
- **File:** `src/metaagent/orchestrator.py`

**Description:**

Modify orchestrator.py to run independent stages concurrently using asyncio.gather(). Independent stages: architecture_sanity and test_suite_mvp can run after alignment_with_prd completes.

### 8. 游 Secure plan writer and Claude Code handoff

- [ ] **Status:** Not started
- **Priority:** High
- **File:** `src/metaagent/plan_writer.py`

**Description:**

Design the mvp_improvement_plan.md format to avoid executable code or shell snippets where possible, and clearly scope Claude Code instructions to only modify the target repo. Add sanitization for all interpolated content (PRD excerpts, analysis summaries, tasks) to avoid embedding malicious content that could trick downstream tools. Document safe operational procedures for developers when using the generated plan.

### 9. 游 Implement secure logging and history management

- [ ] **Status:** Not started
- **Priority:** High
- **File:** `src/metaagent/orchestrator.py`

**Description:**

Create a history log mechanism that stores high-level analysis context without secrets, raw API keys, or other sensitive payloads. Redact or hash any potentially sensitive strings before logging. Ensure log rotation or size limits are in place and document recommended log levels for development vs. production.

### 10. 游리 Optimize prompt template rendering

- [ ] **Status:** Not started
- **Priority:** Medium
- **File:** `src/metaagent/prompts.py`

**Description:**

Profile prompts.py template rendering with large {{code_context}}. Implement token truncation with warning when exceeding METAAGENT_MAX_TOKENS. Add file filtering config to exclude tests/docs from repomix input.

### 11. 游리 Add YAML parsing performance test

- [ ] **Status:** Not started
- **Priority:** Medium
- **File:** `src/metaagent/config.py`

**Description:**

Benchmark config/prompts.yaml and profiles.yaml loading in config.py. Cache parsed configs with file modification watchers. Test with 100+ prompts to ensure <100ms load time.

### 12. 游리 Add dependency and supply-chain security checks

- [ ] **Status:** Not started
- **Priority:** Medium
- **File:** `pyproject.toml`

**Description:**

Specify explicit versions and constraints for critical dependencies (HTTP clients, YAML parser, CLI libraries) in pyproject.toml. Integrate automated tools (e.g., pip-audit, safety, or similar) into the development workflow to detect known vulnerabilities. Avoid unsafe YAML loading (use safe loaders) and review third-party libraries used for CLI and LLM interaction for security posture.

### 13. 游리 Introduce security-focused tests and type checking

- [ ] **Status:** Not started
- **Priority:** Medium
- **File:** `tests/test_orchestrator.py`

**Description:**

Add tests that cover error paths and edge cases for config loading, Repomix execution, and analysis response parsing, ensuring they behave safely under malformed input or hostile content. Integrate static analysis (e.g., bandit), type checking (mypy/pyright), and linting into the test suite to catch common Python security and robustness issues early.

### 14. 游릭 Document secure usage and threat model

- [ ] **Status:** Not started
- **Priority:** Low
- **File:** `README.md`

**Description:**

Extend the PRD and README with a concise threat model for the meta-agent, outlining assumptions (e.g., trusted vs. untrusted repos/PRDs), identified risks (prompt injection, secret leakage, dangerous code suggestions), and mitigations. Provide operational guidance for developers on safely running the tool on third-party codebases and handling generated plans.
